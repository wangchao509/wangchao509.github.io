<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>多线程知识 | whc的学习笔记</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="主要是java技术类笔记">
    
    <link rel="preload" href="/docs/assets/css/0.styles.2753b5fc.css" as="style"><link rel="preload" href="/docs/assets/js/app.29562e48.js" as="script"><link rel="preload" href="/docs/assets/js/5.2be00dd9.js" as="script"><link rel="preload" href="/docs/assets/js/7.20fe6f54.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.d39eef98.js"><link rel="prefetch" href="/docs/assets/js/11.503720a4.js"><link rel="prefetch" href="/docs/assets/js/12.a69a580a.js"><link rel="prefetch" href="/docs/assets/js/13.fb827fa0.js"><link rel="prefetch" href="/docs/assets/js/14.44fa23c4.js"><link rel="prefetch" href="/docs/assets/js/15.7f144ec9.js"><link rel="prefetch" href="/docs/assets/js/2.b17def1c.js"><link rel="prefetch" href="/docs/assets/js/3.54ff3cd5.js"><link rel="prefetch" href="/docs/assets/js/4.a6059a55.js"><link rel="prefetch" href="/docs/assets/js/6.c5b65b2a.js"><link rel="prefetch" href="/docs/assets/js/8.9f0f0100.js"><link rel="prefetch" href="/docs/assets/js/9.89035113.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.2753b5fc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><!----> <span class="site-name">whc的学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/docs/" aria-current="page" class="sidebar-link">站点介绍</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>markdown知识</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/markdown.html" class="sidebar-link">前端知识介绍</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>MySQL知识</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/mysql0.html" class="sidebar-link">MySQL章节0</a></li><li><a href="/docs/mysql.html" class="sidebar-link">MySQL章节1</a></li><li><a href="/docs/mysql2.html" class="sidebar-link">MySQL章节2</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>JAVA知识</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/thread.html" aria-current="page" class="active sidebar-link">多线程知识</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/thread.html#为什么-java-线程没有-running-状态" class="sidebar-link">为什么 Java 线程没有 Running 状态？</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>IDEA知识</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/idea.html" class="sidebar-link">在idea上怎么部署web项目</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>线上故障快速排查</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/analyzeQuestion.html" class="sidebar-link">线上故障快速排查</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>apache ant打包</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/ant.html" class="sidebar-link">Apache Ant</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="多线程知识"><a href="#多线程知识" class="header-anchor">#</a> 多线程知识</h1> <h2 id="为什么-java-线程没有-running-状态"><a href="#为什么-java-线程没有-running-状态" class="header-anchor">#</a> 为什么 Java 线程没有 Running 状态？</h2> <p><img src="/docs/assets/img/thread_state.effde6f6.png" alt="线程状态" title="thread_state.png"></p> <h3 id="什么是runnable"><a href="#什么是runnable" class="header-anchor">#</a> 什么是RUNNABLE？</h3> <blockquote><p>一个在 JVM 中执行的线程处于这一状态中。（A thread executing in the Java virtual machine is in this state.）</p></blockquote> <p>而传统的进（线）程状态一般划分如下(指的是操作系统的线程状态划分)：<br> <img src="/docs/assets/img/thread1.8426ee23.png" alt="传统线程状态" title="thread1.png"></p> <blockquote><p>注：这里的进程指早期的单线程进程，这里所谓进程状态实质就是线程状态。</p></blockquote> <h3 id="与传统的ready状态的区别"><a href="#与传统的ready状态的区别" class="header-anchor">#</a> 与传统的ready状态的区别？</h3> <p>更具体点，javadoc 中是这样说的：</p> <blockquote><p>处于 runnable 状态下的线程正在 Java 虚拟机中执行，但它可能<strong>正在等待</strong>来自于操作系统的其它资源，比如处理器。</p></blockquote> <p><strong>所以RUNNABLE状态实际是包含Ready状态的。</strong></p> <h3 id="与传统的running状态的区别"><a href="#与传统的running状态的区别" class="header-anchor">#</a> 与传统的running状态的区别？</h3> <p>对 Java 线程状态而言，不存在所谓的running 状态，它的 <strong>runnable 状态包含了 running 状态</strong>。<br>
jvm为什么没有区分ready和running状态呢？</p> <p>现在的<strong>时分</strong>（time-sharing）<strong>多任务</strong>（multi-task）操作系统架构通常都是用所谓的“<strong>时间分片（time quantum or time slice）</strong>”方式进行<strong>抢占式</strong>（preemptive）轮转调度（round-robin式）。</p> <p>这个时间分片通常是很小的，一个线程一般只能占有10-20ms的时间（此时处于running状态），时间片段用完后，就要被切换下来放入调度队列的尾部，等待被再次调度（也即回到ready状态）。</p> <blockquote><p>注：如果期间进行了 I/O 的操作还会导致提前释放时间分片，并进入等待队列。<br>
又或者是时间分片没有用完就被抢占，这时也是回到 ready 状态。</p></blockquote> <p>这一切换的过程称为线程的<strong>上下文切换</strong>（context switch），当然 cpu 不是简单地把线程踢开就完了，还需要把<strong>相应的执行状态保存到内存中</strong>以便后续的恢复执行。</p> <p>也这正是单核 <strong>CPU 上实现所谓的“并发</strong>（concurrent）”的基本原理，但<strong>其实是快速切换所带来的假象</strong></p> <blockquote><p>时间分片也是可配置的，如果不追求在多个线程间很快的响应，也可以把这个时间配置得大一点，以减少切换带来的开销。<br>
如果是多核CPU，才有可能实现真正意义上的并发，这种情况通常也叫并行（pararell），不过你可能也会看到这两词会被混着用，这里就不去纠结它们的区别了。</p></blockquote> <p><strong>现今主流的 JVM 实现都把 Java 线程一一映射到操作系统底层的线程上，把调度委托给了操作系统，我们在虚拟机层面看到的状态实质是对底层状态的映射及包装。</strong></p> <p>JVM 本身没有做什么实质的调度，把底层的 ready 及 running 状态映射上来也没多大意义，因此，统一成为runnable 状态是不错的选择。</p> <h3 id="当i-o阻塞时"><a href="#当i-o阻塞时" class="header-anchor">#</a> 当I/O阻塞时</h3> <p>传统的I/O都是阻塞式（blocked）的，原因是I/O操作比起cpu来实在是太慢了，可能差到好几个数量级都说不定。所以如果让CPU去等IO操作，就会导致CPU利用率极低。<br>
解决方案：一旦线程执行到IO相关的代码，响应线程立马切走，然后调度等待队列中另外一个线程来运行。</p> <p>这个被IO阻塞的线程也不会被放到<strong>调度队列</strong>中去，因为很可能再次调度到它时，I/O 可能仍没有完成。</p> <p>线程会被放到所谓的<strong>等待队列</strong>中，处于上图中的 waiting 状态</p> <p>我们所谓阻塞只是指这段时间 cpu 暂时不会理它了，但另一个部件比如硬盘则在努力地为它服务。<br>
当 I/O 完成时，则用一种叫<strong>中断</strong>（interrupt）的机制来通知 cpu：</p> <p>也即所谓的“<strong>中断驱动</strong>（interrupt-driven）”，现代操作系统基本都采用这一机制。</p> <p>当然了，cpu 还是要不断地检查中断，就好比演员们也要时刻注意接听电话，不过这总好过不断主动去询问，毕竟绝大多数的询问都将是徒劳的。</p> <p>cpu 会收到一个比如说来自硬盘的中断信号，并进入中断处理例程，手头正在执行的线程因此被打断，回到 ready 队列。而先前因 I/O 而waiting 的线程随着 I/O 的完成也再次回到 ready 队列，这时 cpu 可能会选择它来执行。</p> <p><strong>时间分片轮转本质上</strong>也是由一个定时器定时中断来驱动的，可以使线程从 running 回到 ready 状态：</p> <h3 id="进行阻塞式-i-o-操作时-java-的线程状态究竟是什么"><a href="#进行阻塞式-i-o-操作时-java-的线程状态究竟是什么" class="header-anchor">#</a> 进行阻塞式 I/O 操作时，Java 的线程状态究竟是什么？</h3> <p>其实状态还是 RUNNABLE</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testInBlockedIOState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Scanner</span> in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建一个名为“输入输出”的线程t</span>
    <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 命令行中的阻塞读</span>
                <span class="token class-name">String</span> input <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">nextLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
              <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;输入输出&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 线程的名字</span>

    <span class="token comment">// 启动</span>
    t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 确保run已经得到执行</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 状态为RUNNABLE</span>
    <span class="token function">assertThat</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token class-name">State</span><span class="token punctuation">.</span>RUNNABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>网络阻塞时同理，比如socket.accept，我们说这是一个“阻塞式(blocked)”式方法，但线程状态还是 RUNNABLE。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testBlockedSocketState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> serverThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ServerSocket</span> serverSocket <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                serverSocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerSocket</span><span class="token punctuation">(</span><span class="token number">10086</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 阻塞的accept方法</span>
                    <span class="token class-name">Socket</span> socket <span class="token operator">=</span> serverSocket<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// TODO</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    serverSocket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;socket线程&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 线程的名字</span>
    serverThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 确保run已经得到执行</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 状态为RUNNABLE</span>
    <span class="token function">assertThat</span><span class="token punctuation">(</span>serverThread<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token class-name">State</span><span class="token punctuation">.</span>RUNNABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><p><font color="0000FF" size="4">至少我们看到了，进行传统上的 IO 操作时，口语上我们也会说“阻塞”，但这个“阻塞”与线程的 BLOCKED 状态是两码事！</font></p> <h3 id="如何看待runnable状态"><a href="#如何看待runnable状态" class="header-anchor">#</a> 如何看待RUNNABLE状态？</h3> <p>注意分清两个层面：<br> <font color="0000FF" size="4">虚拟机VM层面<br>
操作系统OS层面</font></p> <p>虚拟机是骑在你操作系统上面的，身下的操作系统是作为某种资源为满足虚拟机的需求而存在的：<br>
当进行阻塞式的 IO 操作时，或许底层的操作系统线程确实处在阻塞状态，但我们关心的是 JVM 的线程状态。</p> <blockquote><p>JVM 并不关心底层的实现细节，什么时间分片也好，什么 IO 时就要切换也好，它并不关心。</p></blockquote> <p>前面说到，“处于 runnable 状态下的线程正在<strong>Java 虚拟机中执行，但它可能正在等待</strong>来自于操作系统的其它资源，比如处理器。”</p> <p><font color="0000FF" size="4">JVM 把那些都视作资源，cpu 也好，硬盘，网卡也罢，有东西在为线程服务，它就认为线程在“执行”。</font></p> <p>处于 IO 阻塞，只是说 cpu 不执行线程了，但网卡可能还在监听呀，虽然可能暂时没有收到数据：</p> <p><img src="/docs/assets/img/thread2.b5f59a02.png" alt="线程状态" title="thread2.png"></p> <p>https://mp.weixin.qq.com/s/BXtr0IFMY7Azh9820DqZhQ</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/docs/mysql2.html" class="prev">
        MySQL章节2
      </a></span> <span class="next"><a href="/docs/idea.html">
        在idea上怎么部署web项目
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/docs/assets/js/app.29562e48.js" defer></script><script src="/docs/assets/js/5.2be00dd9.js" defer></script><script src="/docs/assets/js/7.20fe6f54.js" defer></script>
  </body>
</html>
